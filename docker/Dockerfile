FROM nvcr.io/nvidia/pytorch:23.06-py3

# 设置工作目录
WORKDIR /workspace

# 设置环境变量
ENV CUDA_VERSION=12.1.1.009 \
    CUDNN_VERSION=8.9.2.26 \
    TORCH_CUDA_ARCH_LIST="5.2 6.0 6.1 7.0 7.5 8.0 8.6 9.0+PTX" \
    TORCH_ALLOW_TF32_CUBLAS_OVERRIDE=1 \
    PYTORCH_VERSION=2.1.0a0+4136153 \
    PYTHONIOENCODING=utf-8 \
    LC_ALL=C.UTF-8 \
    CUDA_HOME=/usr/local/cuda \
    TENSORBOARD_PORT=6006 \
    JUPYTER_PORT=8888 \
    DALI_VERSION=1.26.0 \
    COCOAPI_VERSION=2.0+nv0.7.3 \
    SETUPTOOLS_USE_DISTUTILS=stdlib \
    OPENBLAS_VERSION=0.3.20 \
    NVIDIA_PRODUCT_NAME=PyTorch \
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility,video \
    PATH=/usr/local/lib/python3.10/dist-packages/torch_tensorrt/bin:/usr/local/mpi/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ucx/bin:/opt/tensorrt/bin \
    LD_LIBRARY_PATH=/usr/local/lib/python3.10/dist-packages/torch/lib:/usr/local/lib/python3.10/dist-packages/torch_tensorrt/lib:/usr/local/cuda/compat/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64

# 拷贝必要的 entrypoint（如有定制）
# COPY entrypoint.sh /opt/nvidia/nvidia_entrypoint.sh

RUN apt-get update && apt-get install -y git ffmpeg libsm6 libxext6

RUN pip install --no-cache-dir \
    absl-py==0.15.0 \
    addict==2.4.0 \
    adversarial-robustness-toolbox==1.18.1 \
    advertorch==0.2.3 \
    aenum==3.1.15 \
    aiohttp==3.9.5 \
    aiosignal==1.3.1 \
    albumentations==1.4.7 \
    aliyun-python-sdk-core==2.15.1 \
    aliyun-python-sdk-kms==2.16.2 \
    annotated-types==0.5.0 \
    antlr4-python3-runtime==4.9.3 \
    anykeystore==0.2 \
    apex==0.9.10.dev0 \
    appdirs==1.4.4 \
    astunparse==1.6.3 \
    async-timeout==4.0.3 \
    attrs==23.2.0 \
    beautifulsoup4==4.12.2 \
    bing-images==0.2.3 \
    bleach==6.1.0 \
    blis==0.7.10 \
    cachetools==5.3.1 \
    catalogue==2.0.9 \
    chardet==4.0.0 \
    charset-normalizer==2.0.4 \
    click==8.1.6 \
    clip==1.0 \
    cmake==3.27.2 \
    colorama==0.4.6 \
    confection==0.1.1 \
    contourpy==1.1.0 \
    crcmod==1.7 \
    cryptacular==1.6.2 \
    cryptography==39.0.1 \
    cycler==0.11.0 \
    cymem==2.0.7 \
    dataclasses==0.6 \
    deepspeed==0.4.0 \
    defusedxml==0.7.1 \
    docker-pycreds==0.4.0 \
    einops==0.6.1 \
    entropy-estimators==0.0.2 \
    et-xmlfile==1.1.0 \
    exceptiongroup==1.2.1 \
    facexlib==0.3.0 \
    faiss-gpu==1.7.2 \
    fastai==2.7.12 \
    fastcore==1.5.29 \
    fastdownload==0.0.7 \
    fastjsonschema==2.19.1 \
    fastprogress==1.0.3 \
    filterpy==1.4.5 \
    flatbuffers==1.12 \
    fonttools==4.41.0 \
    frozenlist==1.4.1 \
    fsspec==2023.6.0 \
    ftfy==6.1.1 \
    future==1.0.0 \
    gast==0.3.3 \
    gdown==4.7.1 \
    gitdb==4.0.10 \
    gitpython==3.1.32 \
    google-auth==2.22.0 \
    google-auth-oauthlib==0.4.6 \
    google-pasta==0.2.0 \
    grad-cam==1.4.6 \
    greenlet==2.0.2 \
    grpcio==1.32.0 \
    h11==0.14.0 \
    h5py==2.10.0 \
    higher==0.2.1 \
    huggingface-hub==0.16.4 \
    hupper==1.12 \
    hydra-core==1.3.2 \
    idna==2.10 \
    imageio==2.31.1 \
    imgaug==0.4.0 \
    importlib-metadata==6.8.0 \
    importlib-resources==6.4.0 \
    info-nce-pytorch==0.1.4 \
    ipykernel==6.25.1 \
    ipython==8.12.0 \
    jedi==0.19.0 \
    jmespath==0.10.0 \
    joblib==1.3.2 \
    jsonschema==4.22.0 \
    jupyter_client==7.3.4 \
    jupyter_core==4.12.0 \
    kaggle==1.6.17 \
    keras-preprocessing==1.1.2 \
    kiwisolver==1.4.4 \
    kornia==0.5.11+c8b7b24 \
    langcodes==3.3.0 \
    lazy-loader==0.4 \
    lightly==1.5.13 \
    lightly-utils==0.0.2 \
    lightning-utilities==0.11.2 \
    lit==16.0.6 \
    llvmlite==0.41.1 \
    lmdb==1.4.1 \
    markdown==3.4.3 \
    markdown-it-py==3.0.0 \
    markupsafe==2.1.1 \
    mat4py==0.6.0 \
    matplotlib==3.6.3 \
    mdurl==0.1.2 \
    mlconfig==0.1.8 \
    mmcv==2.2.0 \
    mmengine==0.10.4 \
    model-index==0.1.11 \
    modelindex==0.0.2 \
    multidict==6.0.5 \
    murmurhash==1.0.9 \
    natsort==8.4.0 \
    nbformat==5.10.4 \
    nest-asyncio==1.5.6 \
    networkx==2.8.4 \
    ninja==1.11.1 \
    nltk==3.9.1 \
    numba==0.58.1 \
    numpy==1.22.0 \
    oauthlib==3.2.2 \
    omegaconf==2.3.0 \
    openai-clip==1.0.1 \
    opendatalab==0.0.10 \
    openmim==0.3.9 \
    openpyxl==3.1.2 \
    opentsne==1.0.1 \
    openxlab==0.0.38 \
    opt-einsum==3.3.0 \
    ordered-set==4.1.0 \
    oss2==2.17.0 \
    outcome==1.3.0.post0 \
    oyaml==1.0 \
    palettable==3.3.3 \
    pandas==1.4.4 \
    pastedeploy==3.0.1 \
    pathtools==0.1.2 \
    pathy==0.10.2 \
    pbkdf2==1.3 \
    pillow==9.4.0 \
    plaster==1.1.2 \
    plaster-pastedeploy==1.0.1 \
    platformdirs==4.2.1 \
    plotly==5.22.0 \
    preshed==3.0.8 \
    protobuf==3.20.3 \
    psutil==5.9.5 \
    pyasn1==0.5.0 \
    pyasn1-modules==0.3.0 \
    pycryptodome==3.20.0 \
    pydantic==2.7.1 \
    pydantic-core==2.18.2 \
    pydeprecate==0.3.2 \
    pyiqa==0.1.10 \
    pyparsing==3.1.0 \
    pypinyin==0.51.0 \
    pytorch-lightning==2.3.3 \
    pytorch-pretrained-vit==0.0.7 \
    pytorch-wavelets==1.3.0 \
    pywavelets==1.4.1 \
    pyyaml==6.0.1 \
    referencing==0.35.1 \
    regex==2023.6.3 \
    repoze-sendmail==4.4.1 \
    requests==2.28.2 \
    requests-oauthlib==1.3.1 \
    rich==13.4.2 \
    rsa==4.9 \
    safetensors==0.3.1 \
    scikit-image==0.21.0 \
    scikit-learn==1.3.2 \
    scipy==1.10.1 \
    seaborn==0.12.2 \
    selenium==4.22.0 \
    sentry-sdk==1.29.2 \
    setproctitle==1.3.2 \
    shapely==2.0.4 \
    smart-open==6.3.0 \
    smmap==5.0.0 \
    sniffio==1.3.1 \
    sortedcontainers==2.4.0 \
    soupsieve==2.4.1 \
    spacy==3.6.1 \
    spacy-legacy==3.0.12 \
    spacy-loggers==1.0.4 \
    sqlalchemy==2.0.20 \
    srsly==2.4.7 \
    stack_data==0.6.2 \
    tabulate==0.9.0 \
    tenacity==8.3.0 \
    tensorboard==2.11.2 \
    tensorboard-data-server==0.6.1 \
    tensorboard-plugin-wit==1.8.1 \
    tensorboardx==1.8 \
    tensorflow==2.4.0 \
    tensorflow-estimator==2.4.0 \
    tensorflow-gpu==2.4.0 \
    tensorflow-hub==0.14.0 \
    termcolor==1.1.0 \
    thinc==8.1.12 \
    thop==0.1.1-2209072238 \
    threadpoolctl==3.2.0 \
    tifffile==2023.7.10 \
    timm==0.9.2 \
    tomli==2.0.1 \
    torch==2.0.1 \
    torch-tb-profiler==0.4.3 \
    torchaudio==2.1.0.dev20230719 \
    torchmetrics==1.3.2 \
    torchvision==0.16.0.dev20230719 \
    tqdm==4.65.0 \
    transaction==3.1.0 \
    translationstring==1.4 \
    trio==0.25.1 \
    trio-websocket==0.11.1 \
    triton==2.0.0 \
    ttach==0.0.3 \
    typer==0.9.0 \
    typing-extensions==4.7.1 \
    typing-inspect==0.9.0 \
    urllib3==1.26.16 \
    velruse==1.1.1 \
    venusian==3.0.0 \
    wandb==0.15.8 \
    warmup-scheduler==0.3 \
    wasabi==1.1.2 \
    webencodings==0.5.1 \
    webob==1.8.7 \
    websocket-client==1.8.0 \
    werkzeug==2.3.6 \
    wrapt==1.12.1 \
    wsproto==1.2.0 \
    wtforms==3.0.1 \
    wtforms-recaptcha==0.3.2 \
    xformers==0.0.20 \
    yacs==0.1.8 \
    yapf==0.40.2 \
    yarl==1.9.4 \
    zope-interface==6.0

# 暴露端口
EXPOSE 8888 6006

# 设置默认入口
ENTRYPOINT ["/opt/nvidia/nvidia_entrypoint.sh"]
CMD ["/bin/bash"]